'use strict';

var jsCommon = require('js-common');
var descriptor = require('protobuf-ts/protos/google/protobuf/descriptor');
var annotations = require('protobuf-ts/protos/google/api/annotations');
var _case = require('case');
var mongodb = require('mongodb');
var child_process = require('child_process');
var helpers = require('yargs/helpers');
var Be = require('yargs');
var promises = require('fs/promises');
var fs = require('fs');

function _interopDefault (e) { return e && e.__esModule ? e : { default: e }; }

var Be__default = /*#__PURE__*/_interopDefault(Be);

var Se=(s=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(s,{get:(e,t)=>(typeof require!=="undefined"?require:e)[t]}):s)(function(s){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+s+'" is not supported')});function w(s,e){if(!e)return s;if(!s)return e;for(let[t,r]of jsCommon.KV.entries(e))s[t]=r;return s}function V(s,e,t){if(!s)s={};s[e]=t;return s}var b=class{name;id;client;scopes;host;transport;basePath;version;methods;headers;params;options;constructor(e,t,r,i){this.name=e.name;this.id=e.id;this.client=t;this.options={};if(e.scopes)this.scopes=e.scopes;if(e.basePath)this.basePath=e.basePath;if(e.version)this.version=e.version;this.methods=r;if(i?.credentials)this.options.credentials=i.credentials;let n=i?.headers;let o=i?.params;let{endpoint:c,transport:a}=this.selectTransport(e,i);this.host=c?.host;this.transport=a;n=w(n,c.headers);o=w(o,c.params);if(i?.clientOptions){let d=this.processClientOptions(i.clientOptions);n=w(n,d.headers);o=w(o,d.params);this.options=w(this.options,d.options);}this.headers=n;this.params=o;}selectTransport(e,t){let r;let i;if(t?.host){r=e.endpoints.find(n=>n.host==t.host);if(!r)throw new jsCommon.InvalidArgumentError(`Service endpoint '${t.host}' does not exist`)}if(t?.transport){if(!e.endpoints.length)throw new jsCommon.InvalidArgumentError(`Cannot set transport '${t.transport}' without an endpoint`);if(!r){r=e.endpoints.find(n=>n.transport.includes(t.transport));if(!r)throw new jsCommon.InvalidArgumentError(`Transport '${t.transport}' not supported by any endpoint`)}else if(!r.transport.includes(t.transport)){throw new jsCommon.InvalidArgumentError(`Transport '${t.transport}' not supported, options are: ${r.transport.join(", ")}`)}i=t.transport;}if(!r)r=e.endpoints[0];if(r&&!i)i=r.transport[0];return {endpoint:r,transport:i}}processClientOptions(e){let t;let r;let i;for(let n in e){if(!this.client.options||!(n in this.client.options))throw new jsCommon.InvalidArgumentError(`Client option '${n}' not found`);let o=this.client.options[n];let c=e[n];if(o.enum&&!o.enum.includes(c))throw new jsCommon.InvalidArgumentError(`Client option '${n}' must be one of [${o.enum.join(", ")}], got '${c}'`);if(o.header)t=V(t,o.header,c);else if(o.query)r=V(r,o.query,c);else i=V(i,n,c);}return {headers:t,params:r,options:i}}preflight(){if(!this.host)throw new jsCommon.InvalidArgumentError(`Service '${this}' cannot be used without a valid host`);if(!this.transport)throw new jsCommon.InvalidArgumentError(`Service '${this}' cannot be used without a valid transport`)}getFullPath(e){let t=[];if(this.basePath)t.push(this.basePath);if(this.version)t.push(this.version);t.push(e);return t.join("/")}async transact(e,t,r,i,n){let o=new A;o.setMethod(e);o.url.setHost(this.host);o.url.setPath(t);if(this.params)o.url.setParams(this.params);o.setHeader(jsCommon.HttpHeader.CONTENT_TYPE,i);if(this.headers)o.setHeaders(this.headers);try{o.body=r.encode(n);}catch(a){if(!(a instanceof jsCommon.GenericError))throw new jsCommon.SerializeError(a);throw a}let c=await this.client.request(o,this.options);if(r.response!==void 0){let a=c.headers.get(jsCommon.HttpHeader.CONTENT_TYPE);if(!a||a!==r.response&&!jsCommon.Mime.typeEquals(a,r.response))throw new jsCommon.ApiError(`Expected content type '${r.response}' but got '${a}'`)}try{return r.decode(c.body)}catch(a){if(!(a instanceof jsCommon.GenericError))throw new jsCommon.ParseError(a);throw a}}toString(){return this.id}};var P=class{name;id;options;xssi;constructor(e){this.name=e.name;this.id=e.id;this.options=e.options;this.xssi=e.xssi;}request(e,t){throw new jsCommon.UnimplementedError}};function Me(s){let e={};e[jsCommon.HttpContentType.PROTOBUF]={request:jsCommon.HttpContentType.PROTOBUF,response:jsCommon.HttpContentType.PROTOBUF,encode:t=>s.requestType.encode(t).finish(),decode:t=>s.responseType.decode(t)};e[jsCommon.HttpContentType.PROTOBUFFER]={request:jsCommon.HttpContentType.PROTOBUFFER,response:jsCommon.HttpContentType.PROTOBUFFER,encode:t=>s.requestType.encode(t).finish(),decode:t=>s.responseType.decode(t)};e[jsCommon.HttpContentType.JSON]={request:jsCommon.HttpContentType.JSON,response:jsCommon.HttpContentType.JSON,encode:t=>jsCommon.Json.encode(s.requestType.toJSON(t)),decode:t=>s.responseType.fromJSON(jsCommon.Json.decode(t))};return e}var x=class{constructor(){}static methodsFrom(e){let t={};for(let r in e.methods){let i=e.methods[r];let n=descriptor.MethodOptions.getExtension(i.options,annotations.http);if(!n)throw new jsCommon.UnsupportedError(`Service method ${i.name} has no 'httpRule'`);let o={name:i.name,scopes:[],transport:Me(i)};if(n.get){o.method=jsCommon.HttpMethod.GET;o.path=n.get;}else if(n.put){o.method=jsCommon.HttpMethod.PUT;o.path=n.put;}else if(n.post){o.method=jsCommon.HttpMethod.POST;o.path=n.post;}else if(n.delete){o.method=jsCommon.HttpMethod.DELETE;o.path=n.delete;}else if(n.patch){o.method=jsCommon.HttpMethod.PATCH;o.path=n.patch;}else if(n.custom){o.method=n.custom.kind;o.path=n.custom.path;}t[r]=o;}return t}};var R=class{static installMethod(e,t,r,i){t[r]=function(n){this.preflight();let o=`${e.id}->${i.name}`;let c=i.path;if(c.startsWith("/"))c=c.substring(1);if(!i.transport)throw new jsCommon.UnsupportedError(`Service method '${o}' has no transport`);let a=i.transport[this.transport];if(!a)throw new jsCommon.UnsupportedError(`Service method '${o}' has no transport '${this.transport}'`);let d=i.scopes;if(this.scopes){if(d)d=d.concat(this.scopes);else d=this.scopes;}let f=this.transact.bind(this,i.method,this.getFullPath(c),a,a.request??this.transport);t[r]=f;return f(n)};}static create(e,t){let r=class Mt extends b{};let i=r.prototype;for(let[n,o]of jsCommon.KV.entries(t))this.installMethod(e,i,n,o);return r}};var q=class{clients;transports;services;constructor(){this.clients=new Map;this.transports=new Map;this.services=new Map;}methodsFrom(e){let t={};for(let r of e){let i=_case.camel(r.name);let n={};for(let o of r.transport){let c=this.transports.get(o);if(!c)c=Y.from(o);if(c)n[o]=c;}t[i]={name:r.name,scopes:r.scopes,path:r.path,method:r.method,body:r.body,transport:n};}return t}registerClients(e){for(let t of e){let r=t.implementation??P;delete t.implementation;let i=new r(t);this.clients.set(i.id,i);}}registerServices(e){for(let t of e){let r={};if(t.implementation){if(t.methods)throw new jsCommon.InvalidArgumentError(`Service cannot have both 'implementation' and 'methods'`);let i=t.implementation;if(i.protoOverREST)r=x.methodsFrom(i.protoOverREST);else if(i.gRPC)r=x.methodsFrom(i.gRPC);delete t.implementation;}else if(t.methods){r=this.methodsFrom(t.methods);}this.services.set(t.id,{definition:t,methods:r,implementation:R.create(t,r)});}}registerTransports(e){for(let t of e)this.transports.set(t.id,t.implementation);}create(e,t){let r=this.services.get(e);if(!r)throw new jsCommon.NotFoundError(`Service '${e}' not found`);let i=this.clients.get(r.definition.client);if(!i)throw new jsCommon.NotFoundError(`Client '${r.definition.client}' not found`);return new r.implementation(r.definition,i,r.methods,t)}};var Jt=new q;var _t={parse(s){return s.split(" ")},stringify(s){return s.join(" ")}};var m=class extends jsCommon.GenericError{constructor(e,t="Error authenticating with service"){super(e??"Generic OAuth error",t);}};var y=class extends m{constructor(e){super(e??"Invalid credentials");}};var Q=class extends m{constructor(e){super(e??"Authentication rejected by user");}};var X=class extends m{constructor(e){super(e??"Unrecognized client id");}};var Z=class extends m{constructor(e){super(e??"Unauthorized client");}};var ee=class extends m{constructor(e){super(e??"Invalid scope");}};var te=class{name;id;constructor(e,t){this.name=e;this.id=t;}toString(e){if(e.type)return `${e.type} ${e.secret}`;return e.secret}};var O=class{};var re=class extends O{key;constructor(e){super();this.key=e;}};var C=class extends O{id;issuer;expire;type;secret;metadata;constructor(e){super();this.id=e.id;this.issuer=e.issuer;this.expire=e.expire;this.type=e.type;this.secret=e.secret;this.metadata=e.metadata;}get expired(){if(this.expire===void 0)return false;return Date.now()>this.expire*1e3}toString(){return this.issuer.toString(this)}};var E=class extends C{constructor(e){super(e);}};var l=class extends C{client;scopes;refresher;refreshPromise;constructor(e){super(e);this.client=e.client;this.scopes=e.scopes;this.refresher=e.refresher;}assignToken(e){this.expire=e.expire;this.type=e.type;this.secret=e.secret;this.scopes=e.scopes;this.metadata=e.metadata;}async doRefresh(){if(!this.id)return this.assignToken(await this.issuer.refresh(this,this.refresher));await T.synchronized(this,async e=>{if(e&&e.secret!=this.secret)this.assignToken(e);else this.assignToken(await this.issuer.refresh(this,this.refresher));});}refresh(){if(!this.refresher)throw new y("No refresh token");if(!this.refreshPromise){this.refreshPromise=this.doRefresh();this.refreshPromise.finally(()=>{this.refreshPromise=void 0;});}return this.refreshPromise}revoke(){return this.issuer.revoke(this)}get meta(){return this.metadata??this.refresher?.metadata}};var K=class extends jsCommon.GenericError{constructor(e){super(e,"Database error");}};function g(s){let e={id:s.id,issuer:s.issuer.id,type:s.type,secret:s.secret,expire:s.expire,metadata:s.metadata};if(s instanceof l){e.client=s.client;e.scopes=s.scopes;e.refresher=s.refresher?.id;}return e}function ie(s){return new E({id:s.id,issuer:v.getIssuer(s.issuer),type:s.type,secret:s.secret,expire:s.expire,metadata:s.metadata})}function D(s,e){return new l({id:s.id,issuer:v.getIssuer(s.issuer),type:s.type,secret:s.secret,expire:s.expire,metadata:s.metadata,client:s.client,scopes:s.scopes,refresher:e})}var M=class{};var I=class extends M{keys=new Map;refreshTokens=new Map;accessTokens=new Map;locks=new Map;setKey(e,t){this.keys.set(e,t);}getKey(e){return this.keys.get(e)}deleteKey(e){this.keys.delete(e);}addToken(e){if(e instanceof l)this.accessTokens.set(e.id,e);else this.refreshTokens.set(e.id,e);}updateToken(e){}deleteToken(e){if(e instanceof l)this.accessTokens.delete(e.id);else this.refreshTokens.delete(e.id);}getRefreshToken(e){return this.refreshTokens.get(e)}getAccessToken(e){return this.accessTokens.get(e)}async synchronized(e,t){let r=false;let i=new mongodb.ObjectId().toHexString();let n;let o;for(let a=0;a<15;a++){n=Date.now();o=this.accessTokens.get(e.id);if(!o)break;if(o.secret!=e.secret)break;let d=this.locks.get(e.id);if(!d||d.date<=n-2e4){d={id:i,date:n};this.locks.set(e.id,d);r=true;break}await jsCommon.Promises.resolveAfter(2e3);}let c;try{await t(o);}catch(a){c=a;}if(r||!o){let a=this.locks.get(e.id);let d=a?.id==i;if(d||!a){if(d)this.locks.delete(e.id);this.accessTokens.set(e.id,e);}}if(c)throw c}listAllKeys(){return this.keys}listAllRefreshTokens(){return Array.from(this.refreshTokens.values()).map(e=>g(e))}listAllAccessTokens(){return Array.from(this.accessTokens.values()).map(e=>g(e))}};var $=class extends M{url;db;client;keys;refreshTokens;accessTokens;ready;shouldClose=false;operations=0;closeTimeout;constructor(e,t){super();this.url=e;this.db=t;this.closeTimeout=new jsCommon.Timer({initialTimeout:1e4},()=>this.destroy());}createIndex(e,t){let r=[];for(let[i,n]of jsCommon.KV.entries(t)){let o;if(typeof n=="object"){if(n.unique)o={unique:true};n=n.direction;}r.push(e.createIndex({[i]:n},o));}return Promise.all(r)}async initialize(){this.client=new mongodb.MongoClient(this.url);try{await this.client.connect();}catch(t){this.close();throw new jsCommon.UnavailableError(t)}let e=this.client.db(this.db);this.keys=e.collection("keys");this.refreshTokens=e.collection("refreshTokens");this.accessTokens=e.collection("accessTokens");try{await Promise.all([this.createIndex(this.keys,{key:{direction:1,unique:true}}),this.createIndex(this.refreshTokens,{id:{direction:1,unique:true}}),this.createIndex(this.accessTokens,{id:{direction:1,unique:true},refresher:1})]);}catch(t){this.close();throw new K(t)}this.closeTimeout.start();}close(){this.ready=void 0;this.shouldClose=false;this.closeTimeout.stop();this.client.close();}destroy(){if(this.operations)this.shouldClose=true;else this.close();}async setup(){if(!this.ready)this.ready=this.initialize();else {this.closeTimeout.start();this.shouldClose=false;}return this.ready}runDbOp(e){this.operations++;let t=this.setup().then(e).catch(r=>{throw new K(r)});t.catch(r=>{console.error(`Database operation failed: ${r.stack??r.message}`);}).finally(()=>{this.operations--;if(!this.operations&&this.shouldClose)this.close();});return t}setKey(e,t){return this.runDbOp(()=>this.keys.updateOne({key:e},{$set:{key:e,value:t}},{upsert:true}))}getKey(e){return this.runDbOp(async()=>(await this.keys.findOne({key:e}))?.value)}deleteKey(e){return this.runDbOp(()=>this.keys.deleteOne({key:e}))}addToken(e){let t=g(e);return this.runDbOp(()=>{let r=e instanceof l?this.accessTokens:this.refreshTokens;return r.insertOne(t)})}updateToken(e){let t=g(e);return this.runDbOp(()=>{let r=e instanceof l?this.accessTokens:this.refreshTokens;return r.updateOne({id:t.id},{$set:t})})}deleteToken(e){return this.runDbOp(()=>{let t=e instanceof l?this.accessTokens:this.refreshTokens;return t.deleteOne({id:e.id})})}getRefreshToken(e){return this.runDbOp(async()=>{let t=await this.refreshTokens.findOne({id:e});if(!t)return void 0;return ie(t)})}getAccessToken(e){return this.runDbOp(async()=>{let t=await this.accessTokens.findOne({id:e});if(!t)return void 0;let r;if(t.refresher)r=await this.getRefreshToken(t.refresher);return D(t,r)})}async synchronized(e,t){await this.setup();let r=false;let i=new mongodb.ObjectId;let n;let o;for(let a=0;a<15;a++){n=Date.now();try{let d=await this.accessTokens.updateOne({id:e.id,secret:e.secret,$or:[{lockDate:{$lte:n-2e4}},{lockId:null}]},{$set:{lockId:i,lockDate:n}});if(d.matchedCount){r=true;break}let f=await this.accessTokens.findOne({id:e.id});if(!f)break;o=D(f);if(o.secret!=e.secret)break;await jsCommon.Promises.resolveAfter(2e3);}catch(d){console.error(`Failed to acquire lock: ${d.stack??d.message}`);break}}let c;try{await t(o);}catch(a){c=a;}if(r||!o){let a;if(r){a={lockId:i,lockDate:n};}else {a={lockId:null,lockDate:null};}try{await this.accessTokens.updateOne({id:e.id,...a},{$set:{...g(e),lockDate:void 0,lockId:void 0}});}catch(d){console.error(`Failed to release lock: ${d.stack??d.message}`);}}if(c)throw c}listAllKeys(){return this.runDbOp(async()=>{let e=await this.keys.find().toArray();let t=new Map;for(let r of e)t.set(r.key,r.value);return t})}listAllRefreshTokens(){return this.runDbOp(()=>{return this.refreshTokens.find().toArray()})}listAllAccessTokens(){return this.runDbOp(()=>{return this.accessTokens.find().toArray()})}};var U=class extends I{config;saving;queuedSave=false;constructor(e){super();try{this.config=h.loadConfigSync(e);}catch(r){if(!(r instanceof jsCommon.NotFoundError))throw r;this.config=new h(e,{});}let t=this.config.get("keys");if(t)this.keys=jsCommon.KV.toMap(t);this.loadTokens(this.refreshTokens,true);this.loadTokens(this.accessTokens,false);}loadTokens(e,t){let r=this.config.get(t?"refreshTokens":"accessTokens");if(!r)return;for(let i of r){let n;if(i.refresher)n=this.refreshTokens.get(i.refresher);let o=t?ie(i):D(i,n);e.set(o.id,o);}}saveImpl(){let e=[],t=[];for(let[r,i]of this.refreshTokens)e.push(g(i));for(let[r,i]of this.accessTokens)t.push(g(i));this.config.set("keys",jsCommon.KV.fromMap(this.keys));this.config.set("refreshTokens",e);this.config.set("accessTokens",t);return this.config.save()}async save(){if(this.saving){this.queuedSave=true;return}do{this.queuedSave=false;this.saving=this.saveImpl();try{await this.saving;}catch(e){console.error(`Failed to save credentials: ${e.stack??e.message}`);}}while(this.queuedSave);this.saving=void 0;}setKey(e,t){super.setKey(e,t);this.save();}getKey(e){return super.getKey(e)}deleteKey(e){super.deleteKey(e);}addToken(e){super.addToken(e);this.save();}updateToken(e){super.updateToken(e);this.save();}deleteToken(e){super.deleteToken(e);this.save();}getRefreshToken(e){return super.getRefreshToken(e)}getAccessToken(e){return super.getAccessToken(e)}};var T=class{static DatabaseStorageMedium=$;static medium;constructor(){}static initialize(){if(this.medium)return;let e=h.get("mongodb/url");let t=h.get("credentials/database");if(e&&t){this.medium=new $(e,t);return}let r=h.get("credentials/file");if(r){this.medium=new U(r);return}console.warn("No database to store credentials, using memory");this.medium=new I;}static setKey(e,t){this.initialize();return this.medium.setKey(e,t)}static getKey(e){this.initialize();return this.medium.getKey(e)}static deleteKey(e){this.initialize();return this.medium.deleteKey(e)}static addToken(e){let t=(async()=>{this.initialize();if(e.id)throw new jsCommon.ExistsError("Token already added");e.id=new mongodb.ObjectId().toHexString();if(e instanceof l&&e.refresher&&!e.refresher.id)await this.addToken(e.refresher);await this.medium.addToken(e);})();t.catch(()=>{});return t}static updateToken(e){this.initialize();if(!e.id)throw new jsCommon.NotFoundError("Token not added");return this.medium.updateToken(e)}static deleteToken(e){let t=(async()=>{this.initialize();if(!e.id)throw new jsCommon.NotFoundError("Token not added");await this.medium.deleteToken(e);e.id=void 0;})();return t}static async getRefreshToken(e){this.initialize();let t=await this.medium.getRefreshToken(e);if(!t)throw new jsCommon.NotFoundError(`Refresh token with id '${e}' not found`);return t}static async getAccessToken(e){this.initialize();let t=await this.medium.getAccessToken(e);if(!t)throw new jsCommon.NotFoundError(`Access token with id '${e}' not found`);return t}static synchronized(e,t){if(!e.id)throw new jsCommon.NotFoundError("Token not added");this.initialize();return this.medium.synchronized(e,t)}};var H=class{issuers;clients;constructor(){this.issuers=new Map;this.clients=new Map;}registerIssuers(e){for(let t of e){let r=t.implementation;let i=new r(t.name,t.id);this.issuers.set(i.id,i);}}registerClients(e){for(let t of e)this.clients.set(t.id,t);}getIssuer(e){let t=this.issuers.get(e);if(!t)throw new jsCommon.NotFoundError(`Issuer '${e}' not found`);return t}getClient(e){let t=this.clients.get(e);if(!t)throw new jsCommon.NotFoundError(`Client '${e}' not found`);return t}};var v=new H;var Je=Se("electron");function pr(s,e){let t=child_process.spawn(Je,[s],{stdio:["ipc",process.stdin,process.stdout]});let r=[];let i=false;let n=d=>{switch(d.event){case"ready":if(e){t.send({event:"options",data:e});}t.send({event:"start"});break;case"output":r.push(d.data);break}};let o=d=>{i=true;if(!t.killed)t.kill(d);};let c=o.bind("SIGINT");let a=o.bind("SIGTERM");process.on("SIGINT",c);process.on("SIGTERM",a);return new Promise((d,f)=>{let ve=(F,we)=>{process.off("SIGINT",c);process.off("SIGTERM",a);if(i)return;if(F===0)d(r);else if(F!==null)f(new jsCommon.GenericError(`Child process exited with code ${F}`));else f(new jsCommon.GenericError(`Child process exited with signal ${we}`));};t.on("message",n);t.on("close",ve);})}var ae=class{static optionsFromCmdLine(){let e=Be__default.default(helpers.hideBin(process.argv)).parseSync();let t=e._.join(" ");let r=e.scope;if(typeof r=="string")r=[r];h.use(e.config);delete e.$0;delete e._;delete e.scope;delete e.config;return {client:t,scopes:r,args:e}}static async login(e=this.optionsFromCmdLine()){let{scopes:t,args:r}=e;let i=v.getClient(e.client);let n=v.getIssuer(i.config.issuer);let o=await n.perform(i,t,r);await T.addToken(o);return o}};var _e={};var de=class{constructor(){}static makeError(e,t,r){if(r)t=t?`${r}: ${t}`:r;if(!t)t=`HTTP ${e.status}: ${e.statusText}`;switch(e.status){case 400:case 405:case 413:case 431:return new jsCommon.InvalidArgumentError(t);case 401:return new y(t);case 403:return new jsCommon.PermissionDeniedError(t);case 404:return new jsCommon.NotFoundError(t);case 412:case 428:return new jsCommon.PreconditionFailedError(t);case 418:return new jsCommon.UnsupportedError(t);case 429:return new jsCommon.RateLimitedError(t);case 500:return new jsCommon.InternalServerError(t);case 501:return new jsCommon.UnimplementedError(t);case 502:return new jsCommon.NetworkError(t);case 503:return new jsCommon.UnavailableError(t);case 504:return new jsCommon.TimedOutError(t);case 505:return new jsCommon.UnsupportedError(t)}if(e.status>=400&&e.status<500)throw new jsCommon.ClientError(t);else if(e.status>=500&&e.status<600)throw new jsCommon.ServerError(t);throw new jsCommon.HttpError(t)}};var he={request:jsCommon.HttpContentType.OCTET_STREAM,response:jsCommon.HttpContentType.OCTET_STREAM,encode:s=>s,decode:s=>s};var ue={request:jsCommon.HttpContentType.JSON,response:jsCommon.HttpContentType.JSON,encode:s=>jsCommon.Json.encode(s),decode:s=>jsCommon.Json.decode(s)};var ye={request:jsCommon.HttpContentType.URLFORM,response:jsCommon.HttpContentType.URLFORM,encode:s=>jsCommon.URLParams.toString(s),decode:s=>jsCommon.URLParams.toKV(s.toString())};var Y={from(s){switch(s){case jsCommon.HttpContentType.JSON:return ue;case jsCommon.HttpContentType.URLFORM:return ye;case jsCommon.HttpContentType.OCTET_STREAM:return he}return void 0}};var A=class extends jsCommon.Request{url;constructor(e){super();this.url=new jsCommon.URLBuilder(e);}get https(){return this.url.scheme=="https"}execute(){return super.execute(this.url.href)}};var ct={};var h=class s{static config;path;data;constructor(e,t){this.path=e;this.data=t;}static async read(e){let t;try{t=await promises.readFile(e,"utf8");}catch(r){if(r.code=="ENOENT")throw new jsCommon.NotFoundError(`File not found: ${e}`);throw r}return jsCommon.Yaml.decode(t)}static readSync(e){let t;try{t=fs.readFileSync(e,"utf8");}catch(r){if(r.code=="ENOENT")throw new jsCommon.NotFoundError(`File not found: ${e}`);throw r}return jsCommon.Yaml.decode(t)}static async write(e,t){await promises.writeFile(e,t===void 0?"":jsCommon.Yaml.encode(t));}static async loadConfig(e){return new s(e,await this.read(e))}static loadConfigSync(e){return new s(e,this.readSync(e))}static use(e){this.config=this.loadConfigSync(e??"mosaic_config.yaml");}static get(e){if(!this.config)this.use();return this.config?.get(e)}get(e){let t=this.data;let r=e.split("/");while(r.length){if(t===void 0)return void 0;if(typeof t!="object"||t===null)throw new jsCommon.ParseError(`Could not read config '${e}'`);t=t[r.shift()];}return t}set(e,t){let r=this.data;let i=e.split("/");if(r===void 0||r===null)this.data=r={};while(i.length>1){let n=i.shift();if(r[n]===void 0||r[n]===null){r=r[n]={};continue}if(typeof r[n]!="object")throw new jsCommon.ParseError(`Could not set config '${e}'`);r=r[n];}r[i.shift()]=t;}save(){return s.write(this.path,this.data)}};

exports.AccessToken = l;
exports.ApiKey = re;
exports.ApiRequest = A;
exports.Client = P;
exports.ClientStorage = ct;
exports.Config = h;
exports.CredentialStore = T;
exports.Credentials = O;
exports.DatabaseError = K;
exports.DefaultOAuthProvider = v;
exports.DefaultServiceProvider = Jt;
exports.HttpClients = de;
exports.InvalidCredentialsError = y;
exports.InvalidScopeError = ee;
exports.OAuthError = m;
exports.OAuthIssuer = te;
exports.OAuthProvider = H;
exports.OAuthStorage = _e;
exports.OAuthTools = ae;
exports.RefreshToken = E;
exports.Scopes = _t;
exports.Service = b;
exports.ServiceProvider = q;
exports.Token = C;
exports.Transport = Y;
exports.UnauthorizedClientError = Z;
exports.UnrecognizedIDClientError = X;
exports.UserDeniedError = Q;
exports.launch = pr;
