'use strict';

var jsCommon = require('js-common');
var descriptor = require('protobuf-ts/protos/google/protobuf/descriptor');
var annotations = require('protobuf-ts/protos/google/api/annotations');
var _case = require('case');
var protobufTs = require('protobuf-ts');
var helpers = require('yargs/helpers');
var Fe = require('yargs');
var child_process = require('child_process');

function _interopDefault (e) { return e && e.__esModule ? e : { default: e }; }

var Fe__default = /*#__PURE__*/_interopDefault(Fe);

var L=Object.defineProperty;var i=(s,e)=>L(s,"name",{value:e,configurable:!0}),me=(s=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(s,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):s)(function(s){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+s+'" is not supported')});var D=(s,e)=>{for(var t in e)L(s,t,{get:e[t],enumerable:!0});};var fe={};D(fe,{ApiKey:()=>N,ApiRequest:()=>x,Client:()=>T,Credentials:()=>g,DefaultServiceProvider:()=>Ie,HttpStatus:()=>H,Service:()=>v,ServiceProvider:()=>M,Storage:()=>he,Transport:()=>I});function S(s,e){if(!e)return s;if(!s)return e;for(let[t,r]of jsCommon.KV.entries(e))s[t]=r;return s}i(S,"setKV");function b(s,e,t){return s||(s={}),s[e]=t,s}i(b,"setKVone");var v=class{static{i(this,"Service");}name;id;client;scopes;host;transport;basePath;version;methods;headers;params;options;constructor(e,t,r,o){this.name=e.name,this.id=e.id,this.client=t,this.options={},e.scopes&&(this.scopes=e.scopes),e.basePath&&(this.basePath=e.basePath),e.version&&(this.version=e.version),this.methods=r,o?.credentials&&(this.options.credentials=o.credentials);let n=o?.headers,a=o?.params,{endpoint:p,transport:f}=this.selectTransport(e,o);if(this.host=p?.host,this.transport=f,n=S(n,p.headers),a=S(a,p.params),o?.clientOptions){let c=this.processClientOptions(o.clientOptions);n=S(n,c.headers),a=S(a,c.params),this.options=S(this.options,c.options);}this.headers=n,this.params=a;}selectTransport(e,t){let r,o;if(t?.host&&(r=e.endpoints.find(n=>n.host==t.host),!r))throw new jsCommon.InvalidArgumentError(`Service endpoint '${t.host}' does not exist`);if(t?.transport){if(!e.endpoints.length)throw new jsCommon.InvalidArgumentError(`Cannot set transport '${t.transport}' without an endpoint`);if(r){if(!r.transport.includes(t.transport))throw new jsCommon.InvalidArgumentError(`Transport '${t.transport}' not supported, options are: ${r.transport.join(", ")}`)}else if(r=e.endpoints.find(n=>n.transport.includes(t.transport)),!r)throw new jsCommon.InvalidArgumentError(`Transport '${t.transport}' not supported by any endpoint`);o=t.transport;}return r||(r=e.endpoints[0]),r&&!o&&(o=r.transport[0]),{endpoint:r,transport:o}}processClientOptions(e){let t,r,o;for(let n in e){if(!this.client.options||!(n in this.client.options))throw new jsCommon.InvalidArgumentError(`Client option '${n}' not found`);let a=this.client.options[n],p=e[n];if(a.enum&&!a.enum.includes(p))throw new jsCommon.InvalidArgumentError(`Client option '${n}' must be one of [${a.enum.join(", ")}], got '${p}'`);a.header?t=b(t,a.header,p):a.query?r=b(r,a.query,p):o=b(o,n,p);}return {headers:t,params:r,options:o}}};var T=class{static{i(this,"Client");}name;id;options;xssi;constructor(e){this.name=e.name,this.id=e.id,this.options=e.options,this.xssi=e.xssi;}request(e,t){throw new jsCommon.UnimplementedError}};function we(s){let e={};return e[jsCommon.HttpContentType.PROTOBUF]={request:jsCommon.HttpContentType.PROTOBUF,response:jsCommon.HttpContentType.PROTOBUF,encode:t=>s.requestType.encode(t).finish(),decode:t=>s.responseType.decode(t)},e[jsCommon.HttpContentType.PROTOBUFFER]={request:jsCommon.HttpContentType.PROTOBUFFER,response:jsCommon.HttpContentType.PROTOBUFFER,encode:t=>s.requestType.encode(t).finish(),decode:t=>s.responseType.decode(t)},e[jsCommon.HttpContentType.JSON]={request:jsCommon.HttpContentType.JSON,response:jsCommon.HttpContentType.JSON,encode:t=>jsCommon.Json.encode(s.requestType.toJSON(t)),decode:t=>s.responseType.fromJSON(jsCommon.Json.decode(t))},e}i(we,"transportFrom");var E=class{static{i(this,"ProtoServiceDefinition");}constructor(){}static methodsFrom(e){let t={};for(let r in e.methods){let o=e.methods[r],n=descriptor.MethodOptions.getExtension(o.options,annotations.http);if(!n)throw new jsCommon.UnsupportedError(`Service method ${o.name} has no 'httpRule'`);let a={name:o.name,scopes:[],transport:we(o)};n.get?(a.method=jsCommon.HttpMethod.GET,a.path=n.get):n.put?(a.method=jsCommon.HttpMethod.PUT,a.path=n.put):n.post?(a.method=jsCommon.HttpMethod.POST,a.path=n.post):n.delete?(a.method=jsCommon.HttpMethod.DELETE,a.path=n.delete):n.patch?(a.method=jsCommon.HttpMethod.PATCH,a.path=n.patch):n.custom&&(a.method=n.custom.kind,a.path=n.custom.path),t[r]=a;}return t}};var x=class extends jsCommon.Request{static{i(this,"ApiRequest");}url;constructor(){super(),this.url=new jsCommon.URLBuilder;}get https(){return this.url.scheme=="https"}execute(){return super.execute(this.url.href)}};function Re(s,e){let t=`${s.id}->${e.name}`,r=e.path;return r.startsWith("/")&&(r=r.substring(1)),async function(o){if(!this.host)throw new jsCommon.InvalidArgumentError(`Service method '${t}' called without a host`);if(!this.transport)throw new jsCommon.InvalidArgumentError(`Service method '${t}' called without a transport`);if(!e.transport)throw new jsCommon.UnsupportedError(`Service method '${t}' has no transport`);let n=e.transport[this.transport];if(!n)throw new jsCommon.UnsupportedError(`Service method '${t}' has no transport '${this.transport}'`);let a=e.scopes;this.scopes&&(a?a=a.concat(this.scopes):a=this.scopes);let p=new x;p.url.setHost(this.host),p.setMethod(e.method),this.basePath&&p.url.addPath(this.basePath),this.version&&p.url.addPath(this.version),p.url.addPath(r),this.params&&p.url.setParams(this.params),p.setHeader(jsCommon.HttpHeader.CONTENT_TYPE,n.request??this.transport),this.headers&&p.setHeaders(this.headers);try{p.body=n.encode(o);}catch(c){throw c instanceof jsCommon.GenericError?c:new jsCommon.SerializeError(c)}let f=await this.client.request(p,this.options);if(n.response!==void 0){let c=f.headers.get(jsCommon.HttpHeader.CONTENT_TYPE);if(!c||c!==n.response&&!jsCommon.Mime.typeEquals(c,n.response))throw new jsCommon.ApiError(`Expected content type '${n.response}' but got '${c}'`)}try{return n.decode(f.body)}catch(c){throw c instanceof jsCommon.GenericError?c:new jsCommon.ParseError(c)}}}i(Re,"createMethod");var C=class{static{i(this,"ServiceFactory");}static create(e,t){let r=class extends v{static{i(this,"GeneratedService");}},o=r.prototype;for(let[n,a]of jsCommon.KV.entries(t))o[n]=Re(e,a);return r}};var M=class{static{i(this,"ServiceProvider");}clients;transports;services;constructor(){this.clients=new Map,this.transports=new Map,this.services=new Map;}methodsFrom(e){let t={};for(let r of e){let o=_case.camel(r.name),n={};for(let a of r.transport){let p=this.transports.get(a);p||(p=I.from(a)),p&&(n[a]=p);}t[o]={name:r.name,scopes:r.scopes,path:r.path,method:r.method,body:r.body,transport:n};}return t}registerClients(e){for(let t of e){let r=t.implementation??T;delete t.implementation;let o=new r(t);this.clients.set(o.id,o);}}registerServices(e){for(let t of e){let r={};if(t.implementation){if(t.methods)throw new jsCommon.InvalidArgumentError("Service cannot have both 'implementation' and 'methods'");let o=t.implementation;r=E.methodsFrom(o),delete t.implementation;}else t.methods&&(r=this.methodsFrom(t.methods));this.services.set(t.id,{definition:t,methods:r,implementation:C.create(t,r)});}}registerTransports(e){for(let t of e)this.transports.set(t.id,t.implementation);}create(e,t){let r=this.services.get(e);if(!r)throw new jsCommon.NotFoundError(`Service '${e}' not found`);let o=this.clients.get(r.definition.client);if(!o)throw new jsCommon.NotFoundError(`Client '${r.definition.client}' not found`);return new r.implementation(r.definition,o,r.methods,t)}},Ie=new M;var te={};D(te,{AccessToken:()=>y,DefaultOAuthProvider:()=>u,InvalidCredentialsError:()=>l,InvalidScopeError:()=>q,OAuthError:()=>h,OAuthIssuer:()=>F,OAuthProvider:()=>R,RefreshToken:()=>k,Scopes:()=>Ve,Storage:()=>ee,Store:()=>P,Token:()=>O,UnauthorizedClientError:()=>$,UnrecognizedIDClientError:()=>V,UserDeniedError:()=>K,launch:()=>Je,login:()=>Ne});var Ve={parse(s){return s.split(" ")},stringify(s){return s.join(" ")}},h=class extends jsCommon.GenericError{static{i(this,"OAuthError");}constructor(e,t="Error authenticating with service"){super(e??"Generic OAuth error",t);}},l=class extends h{static{i(this,"InvalidCredentialsError");}constructor(e){super(e??"Invalid credentials");}},K=class extends h{static{i(this,"UserDeniedError");}constructor(e){super(e??"Authentication rejected by user");}},V=class extends h{static{i(this,"UnrecognizedIDClientError");}constructor(e){super(e??"Unrecognized client id");}},$=class extends h{static{i(this,"UnauthorizedClientError");}constructor(e){super(e??"Unauthorized client");}},q=class extends h{static{i(this,"InvalidScopeError");}constructor(e){super(e??"Invalid scope");}};var F=class{static{i(this,"OAuthIssuer");}name;id;constructor(e,t){this.name=e,this.id=t;}};var g=class{static{i(this,"Credentials");}},N=class extends g{static{i(this,"ApiKey");}key;constructor(e){super(),this.key=e;}};var O=class s extends g{static{i(this,"Token");}static counter=0;static createId(){let e=Buffer.alloc(12);return e.writeBigUInt64BE(BigInt(Date.now()),0),e.writeUint32BE(this.counter,8),this.counter++,this.counter>=2**31-1&&(this.counter=0),e.toString("hex")}type;secret;issuer;id;expire;metadata;constructor(e){super(),this.issuer=e.issuer,this.id=e.id??s.createId(),this.expire=e.expire,this.type=e.type,this.secret=e.secret,this.metadata=e.metadata;}toString(){return this.type?`${this.type} ${this.secret}`:this.secret}},k=class extends O{static{i(this,"RefreshToken");}constructor(e){super(e);}},y=class extends O{static{i(this,"AccessToken");}client;scopes;refresher;refreshPromise;constructor(e){super(e),this.client=e.client,this.scopes=e.scopes,this.refresher=e.refresher;}async doRefresh(){let e=await this.issuer.refresh(this,this.refresher);Object.assign(this,{expire:e.expire,type:e.type,secret:e.secret,scopes:e.scopes}),P.updated(this);}get expired(){return this.expire===void 0?!1:Date.now()>this.expire*1e3}refresh(){if(!this.refresher)throw new l("No refresh token");return this.refreshPromise||(this.refreshPromise=this.doRefresh(),this.refreshPromise.finally(()=>{this.refreshPromise=void 0;})),this.refreshPromise}revoke(){return this.issuer.revoke(this)}get meta(){return this.metadata??this.refresher?.metadata}};var R=class{static{i(this,"OAuthProvider");}issuers;clients;constructor(){this.issuers=new Map,this.clients=new Map;}registerIssuers(e){for(let t of e){let r=t.implementation,o=new r(t.name,t.id);this.issuers.set(o.id,o);}}registerClients(e){for(let t of e)this.clients.set(t.id,t);}getIssuer(e){let t=this.issuers.get(e);if(!t)throw new jsCommon.NotFoundError(`Issuer '${e}' not found`);return t}getClient(e){let t=this.clients.get(e);if(!t)throw new jsCommon.NotFoundError(`Client '${e}' not found`);return t}},u=new R;function Ne(){let s=Fe__default.default(helpers.hideBin(process.argv)).parseSync(),e=s._.join(" "),t=u.getClient(e),r=u.getIssuer(t.config.issuer),o=s.scope;return typeof o=="string"&&(o=[o]),protobufTs.Config.use(s.config??"config.yaml"),delete s.$0,delete s._,delete s.scope,delete s.config,r.perform(t,o,s)}i(Ne,"login");var P=class{static{i(this,"Store");}constructor(){}static config;static saving;static queuedSave=!1;static refreshTokens=[];static accessTokens=[];static initialize(){if(this.config)return;let e=protobufTs.Config.get("credentials");if(!e)throw new jsCommon.GenericError("Cannot use credentials store without storage path");try{this.config=protobufTs.Config.loadConfigSync(e);}catch(o){if(!(o instanceof jsCommon.NotFoundError))throw o;this.config=new protobufTs.Config(e,{});}let t,r;if(t=this.config.get("refreshTokens"),t)for(let o of t)this.refreshTokens.push(new k({...o,issuer:u.getIssuer(o.issuer)}));if(r=this.config.get("accessTokens"),r)for(let o of r){let n;o.refresher&&(n=this.getRefreshToken(o.refresher)),this.accessTokens.push(new y({...o,issuer:u.getIssuer(o.issuer),refresher:n}));}}static setKey(e,t){this.initialize(),this.config.set(e,t),this.save();}static getKey(e){return this.initialize(),this.config.get(e)}static add(e){this.initialize(),e instanceof y?this.accessTokens.push(e):this.refreshTokens.push(e),this.saveTokens();}static updated(e){this.initialize(),this.saveTokens();}static getRefreshToken(e){this.initialize();let t=this.refreshTokens.find(r=>r.id==e);if(!t)throw new jsCommon.NotFoundError(`Refresh token with id '${e}' not found`);return t}static getAccessToken(e){this.initialize();let t=this.accessTokens.find(r=>r.id==e);if(!t)throw new jsCommon.NotFoundError(`Access token with id '${e}' not found`);return t}static async saveTokens(){let e=[],t=[];for(let r of this.refreshTokens)e.push({issuer:r.issuer.id,id:r.id,type:r.type,secret:r.secret,expire:r.expire,metadata:r.metadata});for(let r of this.accessTokens)t.push({issuer:r.issuer.id,id:r.id,client:r.client,type:r.type,secret:r.secret,scopes:r.scopes,expire:r.expire,refresher:r.refresher?r.refresher.id:void 0,metadata:r.metadata});this.config.set("refreshTokens",e),this.config.set("accessTokens",t),this.config.save();}static async save(){if(this.config){if(this.saving){this.queuedSave=!0;return}do{this.queuedSave=!1,this.saving=this.config.save();try{await this.saving;}catch(e){console.error(e);}}while(this.queuedSave);this.saving=void 0;}}};var He=me("electron");function Je(s,e){let t=child_process.spawn(He,[s],{stdio:["ipc",process.stdin,process.stdout]}),r=[],o=!1,n=i(c=>{switch(c.event){case"ready":e&&t.send({event:"options",data:e}),t.send({event:"start"});break;case"output":r.push(c.data);break}},"message"),a=i(c=>{o=!0,t.killed||t.kill(c);},"signalHandler"),p=a.bind("SIGINT"),f=a.bind("SIGTERM");return process.on("SIGINT",p),process.on("SIGTERM",f),new Promise((c,G)=>{let le=i((A,ue)=>{process.off("SIGINT",p),process.off("SIGTERM",f),!o&&(A===0?c(r):G(A!==null?new jsCommon.GenericError(`Child process exited with code ${A}`):new jsCommon.GenericError(`Child process exited with signal ${ue}`)));},"close");t.on("message",n),t.on("close",le);})}i(Je,"launch");var ee={};var H=class{static{i(this,"HttpStatus");}constructor(){}static errorFrom(e,t,r){switch(r&&(t=t?`${r}: ${t}`:r),t||(t=`HTTP ${e.status}: ${e.statusText}`),e.status){case 400:case 405:case 413:case 431:return new jsCommon.InvalidArgumentError(t);case 401:return new l(t);case 403:return new jsCommon.PermissionDeniedError(t);case 404:return new jsCommon.NotFoundError(t);case 412:case 428:return new jsCommon.PreconditionFailedError(t);case 418:return new jsCommon.UnsupportedError(t);case 429:return new jsCommon.RateLimitedError(t);case 500:return new jsCommon.InternalServerError(t);case 501:return new jsCommon.UnimplementedError(t);case 502:return new jsCommon.NetworkError(t);case 503:return new jsCommon.UnavailableError(t);case 504:return new jsCommon.TimedOutError(t);case 505:return new jsCommon.UnsupportedError(t)}throw e.status>=400&&e.status<500?new jsCommon.ClientError(t):e.status>=500&&e.status<600?new jsCommon.ServerError(t):new jsCommon.HttpError(t)}};var oe={request:jsCommon.HttpContentType.OCTET_STREAM,response:jsCommon.HttpContentType.OCTET_STREAM,encode:s=>s,decode:s=>s};var ae={request:jsCommon.HttpContentType.JSON,response:jsCommon.HttpContentType.JSON,encode:s=>jsCommon.Json.encode(s),decode:s=>jsCommon.Json.decode(s)};var de={request:jsCommon.HttpContentType.URLFORM,response:jsCommon.HttpContentType.URLFORM,encode:s=>jsCommon.URLParams.toString(s),decode:s=>jsCommon.URLParams.toKV(s.toString())};var I={from(s){switch(s){case jsCommon.HttpContentType.JSON:return ae;case jsCommon.HttpContentType.URLFORM:return de;case jsCommon.HttpContentType.OCTET_STREAM:return oe}}};var he={};

exports.Client = fe;
exports.OAuth = te;
